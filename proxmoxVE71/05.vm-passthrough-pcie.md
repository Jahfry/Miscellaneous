

**NOTES:**

* In BIOS settings on [01 - Hardware](01.Hardware.md) I made a note about setting my boot GPU device (console video) to PCIE Slot 2, which is important to know for this page. 
* This guide is using ZFS on the host boot disk (rpool), so the rest of this assumes systemd boot. If you're using grub I'll drop some extra info but you'll want to look at that part of other guides to be sure. Similarly this guide is focused on AMD X570/Ryzen, so I'm not adding all Intel options. 

---

## VFIO Modules

* **NOTE:** other Linux distributions may have these already built in to the kernel, but Proxmox still uses these as modules
    + Verify this via `cat /boot/config-5.13.19-6-pve |grep -i vfio` (update the name of 'config' for the kernel installed, it will change on updates)
    + Just something to be aware of as guides in the future will likely start omitting this step as it becomes unnecessary
    + Add these lines to '/etc/modules':
        - vfio
        - vfio_iommu_type1
        - vfio_pci
        - vfio_virqfd

```bash
# add this later
``` 
## Boot parameters used

* Add kernel boot parameters
    + systemd
        - Add this to '/etc/kernel/cmdline': " quiet amd_iommu=on iommu=pt"
    + grub 
        - Modify the this line in '/etc/default/grub': 
            * GRUB_CMDLINE_LINUX_DEFAULT=
            * Add this to that line: "quiet amd_iommu=on iommu=pt"
        - `proxmox-boot-tool refresh`

* Apply the above changes:
    + `proxmox-boot-tool refresh`
    + `update-ramfs -u -k all` (or `update-ramfs -u` to only update the current kernel)
        - NOTE: I'm unsure both of these are needed
            * if not, which is better?
            * Need to learn more about 'proxmox-boot-tool'

## Getting GPU IDs:

Use `iommu_list` (created on [this page](04.ProxmoxExtras.md#04b-useful-utilities)) to see the GPU device IDs. My system:

* Big GPU (RTX 3080TI, first PCIE slot): '0b:00.0' (video) and '0b:00.0' (audio)
* Little GPU (GTX 1060, second PCIE slot): '0c:00.0' (video) and '0c:00.0' (audio)
* For use with the next section, add '0000:' to those. Ie, '0b:00.0' becomes '0000:0b:00.0'.
    + and adapt the next commands to match your IDs, you may have something different like '02:00.0', etc.

*Example of the output for my system config:*

<pre>
{snip}
IOMMU Group 28:
	0b:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:2208] (rev a1)
	0b:00.1 Audio device [0403]: NVIDIA Corporation GA102 High Definition Audio Controller [10de:1aef] (rev a1)
IOMMU Group 29:
	0c:00.0 VGA compatible controller [0300]: NVIDIA Corporation GP106 [GeForce GTX 1060 6GB] [10de:1c03] (rev a1)
	0c:00.1 Audio device [0403]: NVIDIA Corporation GP106 High Definition Audio Controller [10de:10f1] (rev a1)
{snip}
</pre>


## Install and configure `driverctl`

**NOTES:**

* 'driverctl' is a part of the Debian Bullseye repositories and has worked for me on multiple Debian-based systems for many months. I use it *instead of blacklisting*. Allows reassigning devices repeatedly and use modules as needed vs blacklisting and disabling those modules ([originally found here](https://www.heiko-sieger.info/blacklisting-graphics-driver/)).
* *If you only have 1 GPU device and override it below,* ***video output to your console monitor will stop***, but you can get it back as needed using commands shown below. 
     + I have 2 GPUs but I'm overriding both below, which will also disconnect console output. 
     + These are different GPU models ... I don't need to worry about having 2 identical devices. 
     + **If you do have 2 identical models** you may need to consult another guide to fix issues (but the following may just work, I can't test)
* *If you have 2 GPUs but only want to use 1 for passthrough*, only do the 'set-override' below for the one you want to passthrough. 
    + Modern GPUs have at least 2 device IDs. 
        - First (0b:00:0) is the video output
        - Second (0b:00.1) is the audio output
        - Newer AMD GPUs may have more
        - Very old GPUs may only have video
* *No easy copy-paste block for these commands to remind you to update for* ***your IOMMU Ids*** before using.*

* `apt install driverctl`
* `driverctl list-devices` ... shows which devices are on what modules currently. Nvidia GPUs will look like this (AMD but is similar with different module names, same for future Intel GPUs):
   + > '0000:0c:00.0 nouveau'
   + > '0000:0c:00.1 snd_hda_intel'
   + **Make note of these default values** so that you can re-attach video to the console later if needed (these will work as shown on Nvidia but if you're using AMD or Intel GPUs, you need to know what modules they booted by default).
* `driverctl list-overrides` ... should be empty for now
* Tell driverctl to override your devices
   + This is the section you should update for your system if different. 
   + This is where your console video will disconnect if you override all of your GPUs. 
   + *This change persists through reboot.*
   + Run these commands (edit for your IDs):
       - `driverctl set-override 0000:0b:00.0 vfio-pci`
       - `driverctl set-override 0000:0b:00.1 vfio-pci`
       - `driverctl set-override 0000:0c:00.0 vfio-pci`
       - `driverctl set-override 0000:0c:00.1 vfio-pci`
* `driverctl list-devices` for the GPU now looks like (the "[\*]" at the end means it is set via the override):
   + > '0000:0c:00.0 vfio-pci [\*]'
   + > '0000:0c:00.1 vfio-pci [\*]'
* `driverctl list-overrides` 
   + Shows all current 'driverctl' overrides (no "[\*]" shown here as it is implied by 'list-overrides'). 

## Reverting `drivertctl` Overrides

This will set your system back to default for whichever devices unset here. Reboot will be needed. 

**NOTE:** Don't do this right now, these are for referrence if you want to change it in the future

* *To unset the overrides* (returns a device to be used, after reboot, the way the system was before 'driverctl' use)
    + `driverctl unset-override 0000:0c.0`
    + `driverctl unset-override 0000:0c.1`
    + *reboot* to get back to this configuration, but:
        - *Console video will not reappear you 'unset-override' until reboot.* 
        - If you want console video **now**, see next:

## Switch between Console Video and VFIO On Demand

This is the most useful for single GPU configurations, allowing you to use console output when needed. 

**NOTES:**

* I'm re-attaching the small GPU. 
* This section is why you made note of the module names from `driverctl list-devices` in the initial 'driverctl' setup. 
    + **If you don't remember what those were:**
        - do "Reverting `driverctl Overrides" from above and reboot, then:
        - `driverctl list-devices` after the reboot
* After running these, your console video should appear immediately on *without rebooting* (assuming this was the device used for console video at boot). 
* *Any 'set-override' persists throuh reboot.*

1. Override to the modules used on a default boot (ie, turn on console video output):

`driverctl set-override 0000:0c.0 nouveau` 
`driverctl set-override 0000:0c.1 snd_hda_intel`

2. Override back to 'vfio-pci' for passing through to a VM (turns console video off):

`driverctl set-override 0000:0c.0 vfio-pci` 
`driverctl set-override 0000:0c.1 vfio-pci`



